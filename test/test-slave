#!/usr/bin/python
import argparse
import sys
import dbus

parser = argparse.ArgumentParser(description='Test dbus slave')
parser.add_argument('-p', '--path', dest="path",
                    help="object path from slave", metavar="PATH")
parser.add_argument('command', metavar='COMMAND', type=str, nargs='?',
                    choices=['info', 'add', 'remove', 'enable'],
                    help='Commands:\n \
                    info,\n \
                    enable [value]\n \
                    add [Id] [Name] [Address]\n \
                    remove [slave path]')
parser.add_argument('value', metavar='VALUE', nargs='*', help='value')
options = parser.parse_args()

bus = dbus.SystemBus()

cmd = options.command
cmd_value = options.value
if (options.path):
	path = options.path
else:
	path = "/"

props = dbus.Interface(bus.get_object("br.org.cesar.modbus", path), "org.freedesktop.DBus.Properties")
manager = dbus.Interface(bus.get_object("br.org.cesar.modbus", path), "br.org.cesar.modbus.Manager1")

if (cmd == "info"):
	print (props.GetAll("br.org.cesar.modbus.Manager1"))
	sys.exit(0)

if (cmd == "add"):
        [slaveid, name, addr] = cmd_value
        idval = dbus.Byte(int(slaveid))
        nameval = dbus.String(name)
        addrval = dbus.String(addr)
        print ("Adding slave:")
        print ("  Id:  %s (1 - 247)" % slaveid)
        print ("  Name:  %s" % nameval)
        print ("  Address:  %s (host:port)" % addr)
        slave_dict = dict()
        slave_dict.update({"Id": idval})
        slave_dict.update({"Name": nameval})
        slave_dict.update({"Address": addrval})
        dbus_dict = dbus.Dictionary(slave_dict, signature='sv')
        path = manager.AddSlave(dbus_dict);
        print ("PATH: %s" % path)
        slave = dbus.Interface(bus.get_object("br.org.cesar.modbus", path), "org.freedesktop.DBus.Properties")
        slave.Set("br.org.cesar.modbus.Slave1", "Enable", True)
        sys.exit(0)

if (cmd == "remove"):
        [objpath] = cmd_value
	print ("Removing slave %s" % objpath)
	devpath = dbus.ObjectPath(objpath)
	print (manager.RemoveSlave(devpath))
	sys.exit(0)

if (cmd == "enable"):
        [value] = cmd_value
        enable = dbus.Boolean(value)
        slave = dbus.Interface(bus.get_object("br.org.cesar.modbus", path), "org.freedesktop.DBus.Properties")
        slave.Set("br.org.cesar.modbus.Slave1", "Enable", enable)
        sys.exit(0)
